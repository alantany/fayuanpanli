# 云端数据库紧急修复指南

## 🚨 **当前状况**
- 数据库目录存在但为空（0个集合，0个文档）
- 需要从JSON文件重新导入数据

## 🔧 **立即修复步骤**

### **步骤1：获取最新修复工具**
```bash
git pull origin cloud-deployment
```

### **步骤2：检查JSON文件**
```bash
# 检查JSON文件是否存在
ls -la db_export.json

# 查看文件大小（应该约32MB）
du -h db_export.json
```

### **步骤3：运行修复脚本**
```bash
# 运行修复脚本（现在会正确识别空数据库）
python fix_db_compatibility.py
```

**预期输出**：
```
🚀 开始数据库兼容性修复...
🔍 检查数据库兼容性...
⚠️  数据库为空，没有任何集合
📦 备份数据库到: db_backup_xxxxx
📁 发现JSON导出文件，尝试导入...
🔧 创建兼容的空数据库结构...
✅ 创建集合: knowledge_base_min_shi_an_li
✅ 创建集合: knowledge_base_xing_shi_an_li
...
📥 从JSON导入数据...
📊 导入信息:
   - 源平台: macOS_M4
   - 导出时间: 2025-05-27T09:34:40.371358
   - 总文档数: 4325
📥 导入集合: knowledge_base_min_shi_an_li
✅ 导入 2046 个文档到 knowledge_base_min_shi_an_li
...
✅ JSON数据导入完成，总计导入 4325 个文档
🎉 数据库兼容性修复完成！
✅ 修复验证成功
```

### **步骤4：验证修复结果**
```bash
# 验证数据库状态
python -c "
import chromadb
client = chromadb.PersistentClient(path='db/')
collections = client.list_collections()
print(f'集合数量: {len(collections)}')
total = 0
for col in collections:
    count = client.get_collection(col.name).count()
    print(f'{col.name}: {count} 个文档')
    total += count
print(f'总计: {total} 个文档')
"
```

**预期结果**：
```
集合数量: 5
knowledge_base_min_shi_an_li: 2046 个文档
knowledge_base_xing_shi_an_li: 1524 个文档
knowledge_base_xing_zheng_an_li: 533 个文档
knowledge_base_zhi_xing_an_li: 178 个文档
knowledge_base_guo_jia_pei_chang_an_li: 44 个文档
总计: 4325 个文档
```

### **步骤5：启动服务**
```bash
# 启动云端服务
python app_cloud.py
```

### **步骤6：测试功能**
```bash
# 健康检查
curl http://localhost:5000/health

# 测试搜索
curl -X POST http://localhost:5000/search \
  -F "query=合同纠纷" \
  -F "case_type_folder=民事案例"
```

## 🔍 **故障排除**

### **如果JSON文件不存在**
```bash
# 检查是否有JSON文件
ls -la *.json

# 如果没有，需要从本地重新上传
# 在本地执行：python export_db_to_json.py
# 然后上传 db_export.json 到云端
```

### **如果导入失败**
```bash
# 检查JSON文件格式
python -c "
import json
with open('db_export.json', 'r') as f:
    data = json.load(f)
print('JSON文件格式正确')
print(f'集合数量: {len([k for k in data.keys() if k != \"_metadata\"])}')
print(f'元数据: {data.get(\"_metadata\", {})}')
"
```

### **如果服务启动失败**
```bash
# 检查端口占用
netstat -tlnp | grep :5000

# 杀死占用进程
pkill -f app_cloud

# 重新启动
python app_cloud.py
```

## 📋 **完成检查清单**

- [ ] JSON文件存在且大小正确（~32MB）
- [ ] 修复脚本成功运行
- [ ] 数据库包含5个集合
- [ ] 总文档数为4325个
- [ ] 服务成功启动
- [ ] 健康检查通过
- [ ] 搜索功能正常

## 🎯 **预期时间**
整个修复过程应该在5-10分钟内完成。 