<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法院判例智能检索</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #0A0F18; /* Very dark blue, almost black */
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #e0e0e0; /* General text: light grey */
        }

        .header {
            background-color: #181F2B; /* Darker than body, but distinct */
            padding: 15px 20px;
            border-bottom: 1px solid #242c37;
            display: flex;
            align-items: center;
            justify-content: center; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            color: #ffffff; 
        }

        .header h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 0.95em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.35);
            word-wrap: break-word; 
        }

        .user-message {
            background-color: #006ACC; /* A brighter, distinct blue for user */
            color: #ffffff;
            align-self: flex-end; 
            border-bottom-right-radius: 4px;
        }

        .system-message {
            background-color: #2A3B4D; /* Dark grey-blue for system */
            color: #e0e0e0;
            align-self: flex-start; 
            border: 1px solid #384a5c;
            border-bottom-left-radius: 4px;
        }
        
        .system-message strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1.05em;
            color: #90caf9; /* Lighter blue for filename */
        }

        .system-message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #1C2833; /* Even darker for pre background */
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #2A3B4D;
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.9em;
            color: #c5c5c5; 
        }
        
        .loading-message, .error-message, .info-message {
            align-self: center; 
            color: #c0c0c0;
            font-style: italic;
            background-color: #222b36; 
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 0.9em;
            border: 1px solid #2d3945;
        }
        .error-message {
            color: #ffab91; /* Light orange/red for error text */
            background-color: #4e0000; /* Very dark red for error background */
            border-color: #6a0000;
        }

        .input-area {
            display: flex;
            align-items: stretch; /* Align items to stretch to fill height */
            padding: 15px 20px;
            background-color: #181F2B; /* Same as header */
            border-top: 1px solid #242c37;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.3);
        }
        
        /* Common styles for height and basic appearance */
        .input-area select,
        .input-area input[type="text"],
        .input-area button {
            box-sizing: border-box;
            padding-top: 14px; 
            padding-bottom: 14px;
            border-radius: 22px; 
            font-size: 1em; 
            line-height: 1.5; 
            outline: none;
        }

        /* Specifics for select */
        .input-area select {
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: auto; 
            min-width: 180px; 
            padding-left: 18px; 
            padding-right: 18px;
            margin-right: 10px;
            background-color: #202836; 
            color: #e0e0e0; 
            border: 1px solid #384a5c;
        }
        .input-area select option {
            background-color: #202836; 
            color: #e0e0e0;
        }

        /* Specifics for input */
        .input-area input[type="text"] {
            flex-grow: 1; 
            flex-shrink: 1;
            flex-basis: 0; 
            min-width: 200px; 
            padding-left: 18px; 
            padding-right: 18px;
            margin-right: 10px;
            background-color: #202836; 
            color: #e0e0e0; 
            border: 1px solid #384a5c;
        }
        
        /* Specifics for button */
        .input-area button {
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: auto; 
            padding-left: 22px; 
            padding-right: 22px;
            background-color: #007bff; 
            color: white;
            font-weight: 500;
            transition: background-color 0.2s ease;
            text-align: center;
            border: 1px solid #007bff; 
            cursor: pointer;
        }

        .input-area select:focus, 
        .input-area input[type="text"]:focus {
            border-color: #90caf9; 
            box-shadow: 0 0 0 2px rgba(144, 202, 249, 0.25);
        }
        
        .input-area button:hover {
            background-color: #0056b3;
            border-color: #0056b3; /* Keep border consistent on hover */
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6c757d; 
        }
        .empty-chat svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            fill: currentColor;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1>法院判例智能检索</h1>
    </div>

    <div class="chat-container" id="chatContainer">
         <div class="empty-chat" id="emptyChatPlaceholder">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
              <path fill-rule="evenodd" d="M3.75 4.5a.75.75 0 01.75-.75h.75c.31 0 .62.07.89.21l.06.03a11.92 11.92 0 007.1 0l.06-.03a1.515 1.515 0 01.89-.21h.75a.75.75 0 01.75.75v12.632a.75.75 0 01-.29.578l-.03.022a11.918 11.918 0 00-14.26 0l-.03-.022a.75.75 0 01-.29-.578V4.5zM9.75 12a.75.75 0 01.75-.75h3a.75.75 0 010 1.5h-3a.75.75 0 01-.75-.75zm-3 2.25a.75.75 0 01.75-.75h6.75a.75.75 0 010 1.5H7.5a.75.75 0 01-.75-.75zM9 7.5A.75.75 0 007.5 9v.043a.75.75 0 000 1.414V10.5a.75.75 0 001.5 0v-.043a.75.75 0 000-1.414V7.5zM14.25 9a.75.75 0 01.75-.75h.043a.75.75 0 011.414 0H16.5a.75.75 0 010 1.5h-.043a.75.75 0 01-1.414 0H14.25a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
            </svg>
            <p>输入关键词开始检索相关案例。</p>
        </div>
    </div>

    <div class="input-area">
        <select name="case_type_folder_select" id="case_type_folder_select">
            {% for display_name, folder_name in case_types.items() %}
                <option value="{{ folder_name }}">{{ display_name }}</option>
            {% endfor %}
        </select>
        <input type="text" id="queryInput" placeholder="在此输入搜索关键词...">
        <button id="sendButton">发送</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const queryInput = document.getElementById('queryInput');
        const sendButton = document.getElementById('sendButton');
        const caseTypeSelect = document.getElementById('case_type_folder_select');
        const emptyChatPlaceholder = document.getElementById('emptyChatPlaceholder');
        let loadingMessageElement = null; 

        function addMessage(text, type, isHtml = false) {
            if (emptyChatPlaceholder && emptyChatPlaceholder.style.display !== 'none') {
                emptyChatPlaceholder.style.display = 'none'; 
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type); 
            
            if (isHtml) {
                messageDiv.innerHTML = text;
            } else {
                messageDiv.textContent = text;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight; 
            return messageDiv; 
        }
        
        function removeLoadingMessage() {
            if (loadingMessageElement && loadingMessageElement.parentNode) {
                loadingMessageElement.remove();
                loadingMessageElement = null;
            }
        }

        async function handleSearch() {
            const query = queryInput.value.trim();
            const caseTypeFolder = caseTypeSelect.value;

            if (!query) {
                addMessage("请输入搜索关键词。", "error-message");
                return;
            }

            addMessage(query, "user-message"); 
            queryInput.value = ''; 
            
            removeLoadingMessage(); 
            loadingMessageElement = addMessage("正在检索中，请稍候...", "loading-message");

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'query': query,
                        'case_type_folder': caseTypeFolder
                    })
                });
                
                removeLoadingMessage(); 

                const data = await response.json();

                if (response.ok) {
                    if (data.error) {
                        addMessage(`检索出错: ${data.error}${data.debug_collection_name ? '\n尝试的集合: ' + data.debug_collection_name : ''}`, "error-message");
                    } else if (data.results && data.results.length > 0) {
                        data.results.forEach(item => {
                            const resultContent = `<strong>${item.filename || '未知文件'}</strong><pre>${item.document}</pre>`;
                            addMessage(resultContent, "system-message", true);
                        });
                    } else {
                        addMessage(`没有找到与 "${query}" 相关的结果。 ${data.debug_collection_name ? '\n(搜索的集合: ' + data.debug_collection_name + ')' : ''}`, "info-message"); 
                    }
                } else {
                     addMessage(`请求错误: ${data.error || response.statusText}${data.debug_collection_name ? '\n尝试的集合: ' + data.debug_collection_name : ''}`, "error-message");
                }
            } catch (error) {
                addMessage(`发生JavaScript错误: ${error.message}`, "error-message");
            } finally {
                 removeLoadingMessage(); 
            }
        }

        sendButton.addEventListener('click', handleSearch);
        queryInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

    </script>
</body>
</html> 